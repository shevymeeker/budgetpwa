<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="stylesheet" href="/fa.min.css">
    <link rel="stylesheet" href="/style.css">
    <meta name="theme-color" content="#161514" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f6f3ee" media="(prefers-color-scheme: light)">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/pwa/icon-192.png">
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'system';
            if (theme === 'light') document.documentElement.setAttribute('data-theme', 'light');
            else if (theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        })();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js'));
        }
    </script>
    <title>ExpenseOwl</title>
</head>
<body>
    <div class="container">
        <header>
            <div class="nav-bar">
                <a href="/"><img src="/pwa/icon-192.png" alt="ExpenseOwl"></a>
                <a href="/" class="view-button active"><i class="fa-solid fa-house"></i></a>
                <a href="/table.html" class="view-button"><i class="fa-solid fa-pen-to-square"></i></a>
                <a href="/settings.html" class="view-button"><i class="fa-solid fa-gear"></i></a>
            </div>
        </header>

        <div class="summary">
            <div class="summary-item">
                <span class="summary-label">Bills</span>
                <span class="summary-value" id="totalBills">--</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Income</span>
                <span class="summary-value" id="totalIncome">--</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Net</span>
                <span class="summary-value" id="netAmount">--</span>
            </div>
        </div>

        <section class="section">
            <div class="section-header">
                <h2>Bills</h2>
                <button id="toggleBillForm" class="btn-add"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div id="billFormContainer" style="display:none;">
                <form id="billForm" class="inline-form">
                    <input type="text" id="billName" placeholder="Bill name" required>
                    <div class="form-row">
                        <input type="number" id="billAmount" step="0.01" min="0.01" placeholder="Amount" inputmode="decimal" required>
                        <input type="date" id="billDueDate" required>
                    </div>
                    <button type="submit" class="btn-primary">Add bill</button>
                </form>
                <div id="billMessage" class="form-message"></div>
            </div>

            <div id="billsList" class="items-list"></div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2>Income</h2>
                <button id="toggleIncomeForm" class="btn-add"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div id="incomeFormContainer" style="display:none;">
                <form id="incomeForm" class="inline-form">
                    <input type="text" id="incomeName" placeholder="Income source" required>
                    <div class="form-row">
                        <input type="number" id="incomeAmount" step="0.01" min="0.01" placeholder="Amount" inputmode="decimal" required>
                        <input type="date" id="incomeDate" required>
                    </div>
                    <button type="submit" class="btn-primary">Add income</button>
                </form>
                <div id="incomeMessage" class="form-message"></div>
            </div>

            <div id="incomeList" class="items-list"></div>
        </section>

        <nav class="bottom-nav">
            <a href="/" class="bottom-nav-item active">
                <i class="fa-solid fa-house"></i><span>Bills</span>
            </a>
            <a href="/table.html" class="bottom-nav-item">
                <i class="fa-solid fa-pen-to-square"></i><span>Manage</span>
            </a>
            <a href="/settings.html" class="bottom-nav-item">
                <i class="fa-solid fa-gear"></i><span>Settings</span>
            </a>
        </nav>
    </div>

    <script src="/functions.js"></script>
    <script src="/db.js"></script>
    <script>
        let currentCurrency = 'usd';
        let allBills = [];
        let allIncome = [];

        function todayStr() {
            const d = new Date();
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        }

        function daysUntil(dateStr) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const target = new Date(dateStr + 'T00:00:00');
            return Math.ceil((target - today) / (1000*60*60*24));
        }

        function formatDate(dateStr) {
            if (!dateStr) return '--';
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function billStatus(bill) {
            const days = daysUntil(bill.dueDate);
            if (days < 0) return 'overdue';
            if (days <= 3) return 'due-soon';
            return 'upcoming';
        }

        function billDueText(bill) {
            const days = daysUntil(bill.dueDate);
            if (days < 0) return `<span class="overdue-text">Overdue ${Math.abs(days)}d</span>`;
            if (days === 0) return `<span class="due-soon-text">Due today</span>`;
            if (days === 1) return `<span class="due-soon-text">Due tomorrow</span>`;
            if (days <= 3) return `<span class="due-soon-text">Due in ${days}d</span>`;
            return `Due ${formatDate(bill.dueDate)}`;
        }

        function advanceMonth(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            const day = d.getDate();
            d.setMonth(d.getMonth() + 1);
            if (d.getDate() !== day) d.setDate(0);
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        }

        function renderBills() {
            const list = document.getElementById('billsList');
            if (allBills.length === 0) {
                list.innerHTML = '<div class="empty-state">No bills yet</div>';
                return;
            }
            const sorted = [...allBills].sort((a,b) => {
                const da = daysUntil(a.dueDate), db = daysUntil(b.dueDate);
                if (da < 0 && db >= 0) return -1;
                if (db < 0 && da >= 0) return 1;
                return da - db;
            });
            list.innerHTML = sorted.map(bill => {
                const status = billStatus(bill);
                const lastPaidText = bill.lastPaid ? `Paid ${formatDate(bill.lastPaid)}` : '';
                return `<div class="bill-item">
                    <div class="bill-status ${status}"></div>
                    <div class="bill-info">
                        <div class="bill-name">${escapeHTML(bill.name)}</div>
                        <div class="bill-due">${billDueText(bill)}${lastPaidText ? ' &middot; ' + lastPaidText : ''}</div>
                    </div>
                    <div class="bill-amount">${formatCurrency(bill.amount)}</div>
                    <div class="bill-actions">
                        <button class="btn-pay" onclick="markPaid('${bill.id}')" title="Mark paid">
                            <i class="fa-solid fa-circle-check"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderIncome() {
            const list = document.getElementById('incomeList');
            if (allIncome.length === 0) {
                list.innerHTML = '<div class="empty-state">No income yet</div>';
                return;
            }
            const sorted = [...allIncome].sort((a,b) => b.date.localeCompare(a.date));
            list.innerHTML = sorted.map(entry => {
                return `<div class="income-item">
                    <div class="income-info">
                        <div class="income-name">${escapeHTML(entry.name)}</div>
                        <div class="income-date">${formatDate(entry.date)}</div>
                    </div>
                    <div class="income-amount">${formatCurrency(entry.amount)}</div>
                </div>`;
            }).join('');
        }

        function updateSummary() {
            const totalBills = allBills.reduce((s, b) => s + b.amount, 0);
            const totalIncome = allIncome.reduce((s, i) => s + i.amount, 0);
            const net = totalIncome - totalBills;
            document.getElementById('totalBills').textContent = formatCurrency(totalBills);
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            const netEl = document.getElementById('netAmount');
            netEl.textContent = formatCurrency(net);
            netEl.className = 'summary-value' + (net >= 0 ? ' positive' : ' negative');
        }

        async function markPaid(id) {
            const bill = allBills.find(b => b.id === id);
            if (!bill) return;
            bill.lastPaid = todayStr();
            bill.dueDate = advanceMonth(bill.dueDate);
            await updateBill(id, bill);
            await loadData();
        }

        async function loadData() {
            const [config, bills, income] = await Promise.all([
                getConfig(), getAllBills(), getAllIncome()
            ]);
            currentCurrency = config.currency;
            allBills = bills;
            allIncome = income;
            renderBills();
            renderIncome();
            updateSummary();
        }

        function toggleForm(containerId) {
            const el = document.getElementById(containerId);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function showMsg(id, text, ok) {
            const el = document.getElementById(id);
            el.textContent = text;
            el.className = 'form-message ' + (ok ? 'success' : 'error');
            setTimeout(() => { el.textContent = ''; el.className = 'form-message'; }, 2500);
        }

        document.getElementById('toggleBillForm').addEventListener('click', () => toggleForm('billFormContainer'));
        document.getElementById('toggleIncomeForm').addEventListener('click', () => toggleForm('incomeFormContainer'));

        document.getElementById('billForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await addBill({
                    name: document.getElementById('billName').value.trim(),
                    amount: parseFloat(document.getElementById('billAmount').value),
                    dueDate: document.getElementById('billDueDate').value,
                    lastPaid: null
                });
                document.getElementById('billForm').reset();
                document.getElementById('billDueDate').value = todayStr();
                showMsg('billMessage', 'Bill added', true);
                await loadData();
            } catch (err) {
                showMsg('billMessage', 'Failed to add bill', false);
            }
        });

        document.getElementById('incomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await addIncome({
                    name: document.getElementById('incomeName').value.trim(),
                    amount: parseFloat(document.getElementById('incomeAmount').value),
                    date: document.getElementById('incomeDate').value
                });
                document.getElementById('incomeForm').reset();
                document.getElementById('incomeDate').value = todayStr();
                showMsg('incomeMessage', 'Income added', true);
                await loadData();
            } catch (err) {
                showMsg('incomeMessage', 'Failed to add income', false);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('billDueDate').value = todayStr();
            document.getElementById('incomeDate').value = todayStr();
            loadData();
        });

        window.markPaid = markPaid;
    </script>
</body>
</html>
