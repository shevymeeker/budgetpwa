<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="stylesheet" href="/fa.min.css">
    <link rel="stylesheet" href="/style.css">
    <meta name="theme-color" content="#161514" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f6f3ee" media="(prefers-color-scheme: light)">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/pwa/icon-192.png">
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'system';
            if (theme === 'light') document.documentElement.setAttribute('data-theme', 'light');
            else if (theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        })();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js'));
        }
    </script>
    <title>ExpenseOwl - Manage</title>
</head>
<body>
    <div class="container">
        <header>
            <div class="nav-bar">
                <a href="/"><img src="/pwa/icon-192.png" alt="ExpenseOwl"></a>
                <a href="/" class="view-button"><i class="fa-solid fa-house"></i></a>
                <a href="/table.html" class="view-button active"><i class="fa-solid fa-pen-to-square"></i></a>
                <a href="/settings.html" class="view-button"><i class="fa-solid fa-gear"></i></a>
            </div>
        </header>

        <section class="section">
            <div class="section-header">
                <h2>Bills</h2>
            </div>
            <div id="billsTable"></div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2>Income</h2>
            </div>
            <div id="incomeTable"></div>
        </section>

        <nav class="bottom-nav">
            <a href="/" class="bottom-nav-item">
                <i class="fa-solid fa-house"></i><span>Bills</span>
            </a>
            <a href="/table.html" class="bottom-nav-item active">
                <i class="fa-solid fa-pen-to-square"></i><span>Manage</span>
            </a>
            <a href="/settings.html" class="bottom-nav-item">
                <i class="fa-solid fa-gear"></i><span>Settings</span>
            </a>
        </nav>
    </div>

    <div id="editBillModal" class="modal">
        <div class="modal-content">
            <h3>Edit bill</h3>
            <div class="modal-form">
                <label>Name</label>
                <input type="text" id="editBillName" required>
                <label>Amount</label>
                <input type="number" id="editBillAmount" step="0.01" min="0.01" required>
                <label>Next due date</label>
                <input type="date" id="editBillDueDate" required>
                <label>Last paid</label>
                <input type="date" id="editBillLastPaid">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeEditBill()">Cancel</button>
                <button class="modal-btn confirm" onclick="saveEditBill()">Save</button>
            </div>
        </div>
    </div>

    <div id="editIncomeModal" class="modal">
        <div class="modal-content">
            <h3>Edit income</h3>
            <div class="modal-form">
                <label>Name</label>
                <input type="text" id="editIncomeName" required>
                <label>Amount</label>
                <input type="number" id="editIncomeAmount" step="0.01" min="0.01" required>
                <label>Date</label>
                <input type="date" id="editIncomeDate" required>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeEditIncome()">Cancel</button>
                <button class="modal-btn confirm" onclick="saveEditIncome()">Save</button>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Delete</h3>
            <p id="deleteMsg">Are you sure? This cannot be undone.</p>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeDelete()">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script src="/functions.js"></script>
    <script src="/db.js"></script>
    <script>
        let currentCurrency = 'usd';
        let allBills = [];
        let allIncome = [];
        let editingBillId = null;
        let editingIncomeId = null;
        let deleteTarget = null;

        function formatDate(dateStr) {
            if (!dateStr) return '--';
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function renderBillsTable() {
            const container = document.getElementById('billsTable');
            if (allBills.length === 0) {
                container.innerHTML = '<div class="empty-state">No bills</div>';
                return;
            }
            const sorted = [...allBills].sort((a,b) => a.dueDate.localeCompare(b.dueDate));
            container.innerHTML = `<table class="data-table">
                <thead><tr>
                    <th>Name</th>
                    <th>Amount</th>
                    <th>Due</th>
                    <th>Last paid</th>
                    <th></th>
                </tr></thead>
                <tbody>${sorted.map(b => `<tr>
                    <td>${escapeHTML(b.name)}</td>
                    <td class="col-amount">${formatCurrency(b.amount)}</td>
                    <td class="col-date">${formatDate(b.dueDate)}</td>
                    <td class="col-date">${b.lastPaid ? formatDate(b.lastPaid) : '--'}</td>
                    <td class="col-actions">
                        <button class="btn-icon" onclick="openEditBill('${b.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-icon danger" onclick="openDelete('bill','${b.id}','${escapeHTML(b.name)}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`).join('')}</tbody>
            </table>`;
        }

        function renderIncomeTable() {
            const container = document.getElementById('incomeTable');
            if (allIncome.length === 0) {
                container.innerHTML = '<div class="empty-state">No income</div>';
                return;
            }
            const sorted = [...allIncome].sort((a,b) => b.date.localeCompare(a.date));
            container.innerHTML = `<table class="data-table">
                <thead><tr>
                    <th>Name</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th></th>
                </tr></thead>
                <tbody>${sorted.map(i => `<tr>
                    <td>${escapeHTML(i.name)}</td>
                    <td class="col-amount">${formatCurrency(i.amount)}</td>
                    <td class="col-date">${formatDate(i.date)}</td>
                    <td class="col-actions">
                        <button class="btn-icon" onclick="openEditIncome('${i.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-icon danger" onclick="openDelete('income','${i.id}','${escapeHTML(i.name)}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`).join('')}</tbody>
            </table>`;
        }

        function openEditBill(id) {
            const bill = allBills.find(b => b.id === id);
            if (!bill) return;
            editingBillId = id;
            document.getElementById('editBillName').value = bill.name;
            document.getElementById('editBillAmount').value = bill.amount;
            document.getElementById('editBillDueDate').value = bill.dueDate;
            document.getElementById('editBillLastPaid').value = bill.lastPaid || '';
            document.getElementById('editBillModal').classList.add('active');
        }

        function closeEditBill() {
            editingBillId = null;
            document.getElementById('editBillModal').classList.remove('active');
        }

        async function saveEditBill() {
            if (!editingBillId) return;
            const bill = {
                name: document.getElementById('editBillName').value.trim(),
                amount: parseFloat(document.getElementById('editBillAmount').value),
                dueDate: document.getElementById('editBillDueDate').value,
                lastPaid: document.getElementById('editBillLastPaid').value || null
            };
            await updateBill(editingBillId, bill);
            closeEditBill();
            await loadData();
        }

        function openEditIncome(id) {
            const entry = allIncome.find(i => i.id === id);
            if (!entry) return;
            editingIncomeId = id;
            document.getElementById('editIncomeName').value = entry.name;
            document.getElementById('editIncomeAmount').value = entry.amount;
            document.getElementById('editIncomeDate').value = entry.date;
            document.getElementById('editIncomeModal').classList.add('active');
        }

        function closeEditIncome() {
            editingIncomeId = null;
            document.getElementById('editIncomeModal').classList.remove('active');
        }

        async function saveEditIncome() {
            if (!editingIncomeId) return;
            const entry = {
                name: document.getElementById('editIncomeName').value.trim(),
                amount: parseFloat(document.getElementById('editIncomeAmount').value),
                date: document.getElementById('editIncomeDate').value
            };
            await updateIncome(editingIncomeId, entry);
            closeEditIncome();
            await loadData();
        }

        function openDelete(type, id, name) {
            deleteTarget = { type, id };
            document.getElementById('deleteMsg').textContent = `Delete "${name}"? This cannot be undone.`;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDelete() {
            deleteTarget = null;
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function confirmDelete() {
            if (!deleteTarget) return;
            if (deleteTarget.type === 'bill') await deleteBill(deleteTarget.id);
            else await deleteIncome(deleteTarget.id);
            closeDelete();
            await loadData();
        }

        async function loadData() {
            const [config, bills, income] = await Promise.all([
                getConfig(), getAllBills(), getAllIncome()
            ]);
            currentCurrency = config.currency;
            allBills = bills;
            allIncome = income;
            renderBillsTable();
            renderIncomeTable();
        }

        // Close modals on backdrop click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    editingBillId = null;
                    editingIncomeId = null;
                    deleteTarget = null;
                }
            });
        });

        document.addEventListener('DOMContentLoaded', loadData);

        window.openEditBill = openEditBill;
        window.closeEditBill = closeEditBill;
        window.saveEditBill = saveEditBill;
        window.openEditIncome = openEditIncome;
        window.closeEditIncome = closeEditIncome;
        window.saveEditIncome = saveEditIncome;
        window.openDelete = openDelete;
        window.closeDelete = closeDelete;
        window.confirmDelete = confirmDelete;
    </script>
</body>
</html>
