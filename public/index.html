<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="stylesheet" href="/fa.min.css">
    <link rel="stylesheet" href="/style.css">
    <meta name="theme-color" content="#161514" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f6f3ee" media="(prefers-color-scheme: light)">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/pwa/icon-192.png">
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'system';
            if (theme === 'light') document.documentElement.setAttribute('data-theme', 'light');
            else if (theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        })();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js'));
        }
    </script>
    <title>Wildman Money Tracker</title>
</head>
<body>
    <div class="container">
        <header>
            <div class="nav-bar">
                <a href="/"><img src="/pwa/icon-192.png" alt="Wildman Money Tracker"></a>
                <a href="/" class="view-button active"><i class="fa-solid fa-house"></i></a>
                <a href="/table.html" class="view-button"><i class="fa-solid fa-pen-to-square"></i></a>
                <a href="/settings.html" class="view-button"><i class="fa-solid fa-gear"></i></a>
            </div>
        </header>

        <div class="summary">
            <div class="summary-item">
                <span class="summary-label">Bills</span>
                <span class="summary-value" id="totalBills">--</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Income</span>
                <span class="summary-value" id="totalIncome">--</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Net</span>
                <span class="summary-value" id="netAmount">--</span>
            </div>
        </div>

        <section class="section charts-section" id="chartsSection">
            <div class="section-header">
                <h2>Charts</h2>
            </div>
            <div class="charts-grid" id="chartsGrid">
                <div class="chart-card" id="pieCard">
                    <h3 class="chart-title">Bill Breakdown</h3>
                    <div class="chart-wrap">
                        <canvas id="billPieChart"></canvas>
                    </div>
                    <div id="billPieLegend" class="chart-legend"></div>
                </div>
                <div class="chart-card" id="doughnutCard">
                    <h3 class="chart-title">Income vs Bills</h3>
                    <div class="chart-wrap">
                        <canvas id="incomeVsBillsChart"></canvas>
                    </div>
                </div>
                <div class="chart-card" id="barCard">
                    <h3 class="chart-title">Monthly Cash Flow</h3>
                    <div class="chart-wrap chart-wrap-bar">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>
            <div id="chartsEmpty" class="empty-state" style="display:none;">Add bills and income to see charts</div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2>Bills</h2>
                <button id="toggleBillForm" class="btn-add"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div id="billFormContainer" style="display:none;">
                <form id="billForm" class="inline-form">
                    <input type="text" id="billName" placeholder="Bill name" required>
                    <div class="form-row">
                        <input type="number" id="billAmount" step="0.01" min="0.01" placeholder="Amount" inputmode="decimal" required>
                        <input type="date" id="billDueDate" required>
                    </div>
                    <button type="submit" class="btn-primary">Add bill</button>
                </form>
                <div id="billMessage" class="form-message"></div>
            </div>

            <div id="billsList" class="items-list"></div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2>Income</h2>
                <button id="toggleIncomeForm" class="btn-add"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div id="incomeFormContainer" style="display:none;">
                <form id="incomeForm" class="inline-form">
                    <input type="text" id="incomeName" placeholder="Income source" required>
                    <div class="form-row">
                        <input type="number" id="incomeAmount" step="0.01" min="0.01" placeholder="Amount" inputmode="decimal" required>
                        <input type="date" id="incomeDate" required>
                    </div>
                    <button type="submit" class="btn-primary">Add income</button>
                </form>
                <div id="incomeMessage" class="form-message"></div>
            </div>

            <div id="incomeList" class="items-list"></div>
        </section>

        <nav class="bottom-nav">
            <a href="/" class="bottom-nav-item active">
                <i class="fa-solid fa-house"></i><span>Bills</span>
            </a>
            <a href="/table.html" class="bottom-nav-item">
                <i class="fa-solid fa-pen-to-square"></i><span>Manage</span>
            </a>
            <a href="/settings.html" class="bottom-nav-item">
                <i class="fa-solid fa-gear"></i><span>Settings</span>
            </a>
        </nav>
    </div>

    <script src="/functions.js"></script>
    <script src="/db.js"></script>
    <script src="/chart.min.js"></script>
    <script>
        let currentCurrency = 'usd';
        let allBills = [];
        let allIncome = [];

        // Chart instances
        let billPieChart = null;
        let incomeVsBillsChart = null;
        let timelineChart = null;

        // Plugin: 3D shadow effect on data segments only
        const shadow3DPlugin = {
            id: 'shadow3D',
            beforeDatasetsDraw(chart) {
                const ctx = chart.ctx;
                ctx.save();
                ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
                ctx.shadowBlur = 16;
                ctx.shadowOffsetX = 4;
                ctx.shadowOffsetY = 8;
            },
            afterDatasetsDraw(chart) {
                chart.ctx.restore();
            }
        };

        // Plugin: center text for doughnut chart
        const centerTextPlugin = {
            id: 'centerText',
            afterDraw(chart) {
                const opts = chart.config.options.plugins?.centerText;
                if (chart.config.type !== 'doughnut' || !opts) return;
                const { text, subtext, color, subcolor } = opts;
                const ctx = chart.ctx;
                const { top, bottom, left, right } = chart.chartArea;
                const cx = (left + right) / 2;
                const cy = (top + bottom) / 2;
                const radius = (bottom - top) / 2;
                const mainSize = Math.max(12, radius * 0.28);
                const subSize = Math.max(9, radius * 0.17);

                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                ctx.font = `bold ${mainSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
                ctx.fillStyle = color;
                ctx.fillText(text, cx, subtext ? cy - mainSize * 0.35 : cy);

                if (subtext) {
                    ctx.font = `600 ${subSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
                    ctx.fillStyle = subcolor || color;
                    ctx.fillText(subtext, cx, cy + mainSize * 0.55);
                }
                ctx.restore();
            }
        };

        Chart.register(shadow3DPlugin, centerTextPlugin);

        function todayStr() {
            const d = new Date();
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        }

        function daysUntil(dateStr) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const target = new Date(dateStr + 'T00:00:00');
            return Math.ceil((target - today) / (1000*60*60*24));
        }

        function formatDate(dateStr) {
            if (!dateStr) return '--';
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function billStatus(bill) {
            const days = daysUntil(bill.dueDate);
            if (days < 0) return 'overdue';
            if (days <= 3) return 'due-soon';
            return 'upcoming';
        }

        function billDueText(bill) {
            const days = daysUntil(bill.dueDate);
            if (days < 0) return `<span class="overdue-text">Overdue ${Math.abs(days)}d</span>`;
            if (days === 0) return `<span class="due-soon-text">Due today</span>`;
            if (days === 1) return `<span class="due-soon-text">Due tomorrow</span>`;
            if (days <= 3) return `<span class="due-soon-text">Due in ${days}d</span>`;
            return `Due ${formatDate(bill.dueDate)}`;
        }

        function advanceMonth(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            const day = d.getDate();
            d.setMonth(d.getMonth() + 1);
            if (d.getDate() !== day) d.setDate(0);
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        }

        function renderBills() {
            const list = document.getElementById('billsList');
            if (allBills.length === 0) {
                list.innerHTML = '<div class="empty-state">No bills yet</div>';
                return;
            }
            const sorted = [...allBills].sort((a,b) => {
                const da = daysUntil(a.dueDate), db = daysUntil(b.dueDate);
                if (da < 0 && db >= 0) return -1;
                if (db < 0 && da >= 0) return 1;
                return da - db;
            });
            list.innerHTML = sorted.map(bill => {
                const status = billStatus(bill);
                const lastPaidText = bill.lastPaid ? `Paid ${formatDate(bill.lastPaid)}` : '';
                return `<div class="bill-item">
                    <div class="bill-status ${status}"></div>
                    <div class="bill-info">
                        <div class="bill-name">${escapeHTML(bill.name)}</div>
                        <div class="bill-due">${billDueText(bill)}${lastPaidText ? ' &middot; ' + lastPaidText : ''}</div>
                    </div>
                    <div class="bill-amount">${formatCurrency(bill.amount)}</div>
                    <div class="bill-actions">
                        <button class="btn-pay" onclick="markPaid('${bill.id}')" title="Mark paid">
                            <i class="fa-solid fa-circle-check"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderIncome() {
            const list = document.getElementById('incomeList');
            if (allIncome.length === 0) {
                list.innerHTML = '<div class="empty-state">No income yet</div>';
                return;
            }
            const sorted = [...allIncome].sort((a,b) => b.date.localeCompare(a.date));
            list.innerHTML = sorted.map(entry => {
                return `<div class="income-item">
                    <div class="income-info">
                        <div class="income-name">${escapeHTML(entry.name)}</div>
                        <div class="income-date">${formatDate(entry.date)}</div>
                    </div>
                    <div class="income-amount">${formatCurrency(entry.amount)}</div>
                </div>`;
            }).join('');
        }

        function updateSummary() {
            const totalBills = allBills.reduce((s, b) => s + b.amount, 0);
            const totalIncome = allIncome.reduce((s, i) => s + i.amount, 0);
            const net = totalIncome - totalBills;
            document.getElementById('totalBills').textContent = formatCurrency(totalBills);
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            const netEl = document.getElementById('netAmount');
            netEl.textContent = formatCurrency(net);
            netEl.className = 'summary-value' + (net >= 0 ? ' positive' : ' negative');
        }

        function getThemeColor(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        function renderCharts() {
            const chartsGrid = document.getElementById('chartsGrid');
            const chartsEmpty = document.getElementById('chartsEmpty');

            if (allBills.length === 0 && allIncome.length === 0) {
                chartsGrid.style.display = 'none';
                chartsEmpty.style.display = 'block';
                return;
            }
            chartsGrid.style.display = '';
            chartsEmpty.style.display = 'none';

            renderBillPieChart();
            renderIncomeVsBillsChart();
            renderTimelineChart();
        }

        function renderBillPieChart() {
            const canvas = document.getElementById('billPieChart');
            const legendEl = document.getElementById('billPieLegend');
            const card = document.getElementById('pieCard');

            if (billPieChart) { billPieChart.destroy(); billPieChart = null; }

            if (allBills.length === 0) {
                card.style.display = 'none';
                return;
            }
            card.style.display = '';

            const labels = allBills.map(b => b.name);
            const data = allBills.map(b => b.amount);
            const total = data.reduce((s, v) => s + v, 0);
            const colors = allBills.map((_, i) => colorPalette[i % colorPalette.length]);

            // Brighter highlight borders for 3D bevel effect
            const borderColors = colors.map(c => {
                const r = parseInt(c.slice(1,3),16), g = parseInt(c.slice(3,5),16), b = parseInt(c.slice(5,7),16);
                return `rgb(${Math.min(255,r+50)},${Math.min(255,g+50)},${Math.min(255,b+50)})`;
            });

            billPieChart = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        hoverOffset: 18,
                        offset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(20,20,18,0.95)',
                            titleFont: { size: 14, weight: 'bold', family: '-apple-system, BlinkMacSystemFont, sans-serif' },
                            bodyFont: { size: 13, weight: '600', family: '-apple-system, BlinkMacSystemFont, sans-serif' },
                            padding: 14,
                            cornerRadius: 10,
                            displayColors: true,
                            boxPadding: 6,
                            callbacks: {
                                label(ctx) {
                                    const pct = ((ctx.parsed / total) * 100).toFixed(1);
                                    return ` ${formatCurrency(ctx.parsed)}  (${pct}%)`;
                                }
                            }
                        }
                    },
                    layout: { padding: 8 }
                }
            });

            // Custom legend below the chart
            legendEl.innerHTML = allBills.map((bill, i) => {
                const pct = ((bill.amount / total) * 100).toFixed(1);
                return `<div class="legend-item">
                    <span class="legend-dot" style="background:${colors[i]}"></span>
                    <span class="legend-label">${escapeHTML(bill.name)}</span>
                    <span class="legend-value">${pct}%</span>
                </div>`;
            }).join('');
        }

        function renderIncomeVsBillsChart() {
            const canvas = document.getElementById('incomeVsBillsChart');
            const card = document.getElementById('doughnutCard');

            if (incomeVsBillsChart) { incomeVsBillsChart.destroy(); incomeVsBillsChart = null; }

            const totalBills = allBills.reduce((s, b) => s + b.amount, 0);
            const totalIncome = allIncome.reduce((s, i) => s + i.amount, 0);

            if (totalBills === 0 && totalIncome === 0) {
                card.style.display = 'none';
                return;
            }
            card.style.display = '';

            const net = totalIncome - totalBills;
            const remaining = Math.max(0, net);

            let data, bgColors, hoverColors, labels;
            if (totalIncome >= totalBills) {
                data = [totalBills, remaining];
                bgColors = ['#c44040', '#5a9a6a'];
                hoverColors = ['#d45555', '#6ab07a'];
                labels = ['Total Bills', 'Remaining'];
            } else {
                data = [totalIncome, Math.abs(net)];
                bgColors = ['#c49040', '#c44040'];
                hoverColors = ['#d4a050', '#d45555'];
                labels = ['Income', 'Over Budget'];
            }

            const textColor = getThemeColor('--text');
            const dimColor = getThemeColor('--text-dim');

            incomeVsBillsChart = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: bgColors,
                        hoverBackgroundColor: hoverColors,
                        borderColor: bgColors.map(c => {
                            const r = parseInt(c.slice(1,3),16), g = parseInt(c.slice(3,5),16), b = parseInt(c.slice(5,7),16);
                            return `rgb(${Math.min(255,r+40)},${Math.min(255,g+40)},${Math.min(255,b+40)})`;
                        }),
                        borderWidth: 2,
                        hoverOffset: 12,
                        cutout: '60%',
                        spacing: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                font: { size: 13, weight: 'bold', family: '-apple-system, BlinkMacSystemFont, sans-serif' },
                                padding: 16,
                                usePointStyle: true,
                                pointStyleWidth: 12
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(20,20,18,0.95)',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13, weight: '600' },
                            padding: 14,
                            cornerRadius: 10,
                            displayColors: true,
                            boxPadding: 6,
                            callbacks: {
                                label(ctx) {
                                    return ` ${formatCurrency(ctx.parsed)}`;
                                }
                            }
                        },
                        centerText: {
                            text: formatCurrency(Math.abs(net)),
                            subtext: net >= 0 ? 'Remaining' : 'Over Budget',
                            color: net >= 0 ? '#5a9a6a' : '#c44040',
                            subcolor: dimColor
                        }
                    },
                    layout: { padding: 8 }
                }
            });
        }

        function renderTimelineChart() {
            const canvas = document.getElementById('timelineChart');
            const card = document.getElementById('barCard');

            if (timelineChart) { timelineChart.destroy(); timelineChart = null; }

            if (allBills.length === 0 && allIncome.length === 0) {
                card.style.display = 'none';
                return;
            }
            card.style.display = '';

            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const dayLabels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const currentMonthName = monthNames[now.getMonth()];

            // Map bills to day-of-month from their due dates
            const billsByDay = new Array(daysInMonth).fill(0);
            allBills.forEach(b => {
                const d = new Date(b.dueDate + 'T00:00:00');
                const day = d.getDate();
                if (day >= 1 && day <= daysInMonth) {
                    billsByDay[day - 1] += b.amount;
                }
            });

            // Map income to day-of-month
            const incomeByDay = new Array(daysInMonth).fill(0);
            allIncome.forEach(inc => {
                const d = new Date(inc.date + 'T00:00:00');
                const day = d.getDate();
                if (day >= 1 && day <= daysInMonth) {
                    incomeByDay[day - 1] += inc.amount;
                }
            });

            const textColor = getThemeColor('--text');
            const dimColor = getThemeColor('--text-dim');
            const gridColor = getThemeColor('--border');

            // Create gradient fills
            const ctx = canvas.getContext('2d');
            const incomeGrad = ctx.createLinearGradient(0, 0, 0, 220);
            incomeGrad.addColorStop(0, 'rgba(90, 154, 106, 0.95)');
            incomeGrad.addColorStop(1, 'rgba(90, 154, 106, 0.5)');
            const billsGrad = ctx.createLinearGradient(0, 0, 0, 220);
            billsGrad.addColorStop(0, 'rgba(196, 64, 64, 0.95)');
            billsGrad.addColorStop(1, 'rgba(196, 64, 64, 0.5)');

            timelineChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeByDay,
                            backgroundColor: incomeGrad,
                            borderColor: '#6ab07a',
                            borderWidth: 1,
                            borderRadius: 5,
                            borderSkipped: false
                        },
                        {
                            label: 'Bills Due',
                            data: billsByDay,
                            backgroundColor: billsGrad,
                            borderColor: '#d45555',
                            borderWidth: 1,
                            borderRadius: 5,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: textColor,
                                font: { size: 12, weight: 'bold', family: '-apple-system, BlinkMacSystemFont, sans-serif' },
                                padding: 14,
                                usePointStyle: true,
                                pointStyleWidth: 10
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(20,20,18,0.95)',
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12, weight: '600' },
                            padding: 12,
                            cornerRadius: 10,
                            filter(item) { return item.parsed.y > 0; },
                            callbacks: {
                                title(items) {
                                    return currentMonthName + ' ' + items[0].label;
                                },
                                label(ctx) {
                                    return ` ${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: gridColor + '40', lineWidth: 0.5 },
                            ticks: {
                                color: dimColor,
                                font: { size: 10, weight: '700' },
                                maxRotation: 0,
                                callback(val, idx) {
                                    const day = idx + 1;
                                    return (day === 1 || day % 5 === 0) ? day : '';
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor + '40', lineWidth: 0.5 },
                            ticks: {
                                color: dimColor,
                                font: { size: 10, weight: '700' },
                                callback(val) { return formatCurrency(val); }
                            }
                        }
                    },
                    layout: { padding: { left: 4, right: 8, top: 4, bottom: 4 } }
                }
            });
        }

        async function markPaid(id) {
            const bill = allBills.find(b => b.id === id);
            if (!bill) return;
            bill.lastPaid = todayStr();
            bill.dueDate = advanceMonth(bill.dueDate);
            await updateBill(id, bill);
            await loadData();
        }

        async function loadData() {
            const [config, bills, income] = await Promise.all([
                getConfig(), getAllBills(), getAllIncome()
            ]);
            currentCurrency = config.currency;
            allBills = bills;
            allIncome = income;
            renderBills();
            renderIncome();
            updateSummary();
            renderCharts();
        }

        function toggleForm(containerId) {
            const el = document.getElementById(containerId);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function showMsg(id, text, ok) {
            const el = document.getElementById(id);
            el.textContent = text;
            el.className = 'form-message ' + (ok ? 'success' : 'error');
            setTimeout(() => { el.textContent = ''; el.className = 'form-message'; }, 2500);
        }

        document.getElementById('toggleBillForm').addEventListener('click', () => toggleForm('billFormContainer'));
        document.getElementById('toggleIncomeForm').addEventListener('click', () => toggleForm('incomeFormContainer'));

        document.getElementById('billForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await addBill({
                    name: document.getElementById('billName').value.trim(),
                    amount: parseFloat(document.getElementById('billAmount').value),
                    dueDate: document.getElementById('billDueDate').value,
                    lastPaid: null
                });
                document.getElementById('billForm').reset();
                document.getElementById('billDueDate').value = todayStr();
                showMsg('billMessage', 'Bill added', true);
                await loadData();
            } catch (err) {
                showMsg('billMessage', 'Failed to add bill', false);
            }
        });

        document.getElementById('incomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await addIncome({
                    name: document.getElementById('incomeName').value.trim(),
                    amount: parseFloat(document.getElementById('incomeAmount').value),
                    date: document.getElementById('incomeDate').value
                });
                document.getElementById('incomeForm').reset();
                document.getElementById('incomeDate').value = todayStr();
                showMsg('incomeMessage', 'Income added', true);
                await loadData();
            } catch (err) {
                showMsg('incomeMessage', 'Failed to add income', false);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('billDueDate').value = todayStr();
            document.getElementById('incomeDate').value = todayStr();
            loadData();
        });

        window.markPaid = markPaid;
    </script>
</body>
</html>
